version: 0.2
phases:
  deploy:
    commands:
      - aws eks --region "$AWS_REGION" update-kubeconfig --name "$EKS_CLUSTER"
      - kubectl get svc
      - sed "s|imageName|$DOCKER_REG/$IMAGE_NAME:$IMAGE_TAG|g" deployment.yaml > my-deployment.yaml
      - cat my-deployment.yaml
      - kubectl apply -f my-deployment.yaml
      - while [ -z "$url" ]; do url=$(kubectl describe service demo-app | grep 'LoadBalancer Ingress:' | awk 'printf "https://%s",$3;'); sleep 2; done
      - echo "$url"
      - echo "Demo App launched!"

